version: "3.8"

networks:
  base-network:
    driver: bridge
    name: deathstar-network

volumes:
  ctx:
    driver: local
    driver_opts:
      type: none
      device: ../../
      # device: $PWD/${WEB_APP_PATH}
      o: bind

services:

  peer1:
    image: deathstar.peer1
    build:
      context: ./peer
      dockerfile: ./Dockerfile
      args:
        workdir:  /ctx/DeathStarGame/bin/app-node
    command: tail -f /dev/null
    # command: bash f dev
    ports:
      - 9511:9501
      - 8811:8801
      - 9611:9631

      - 9510:9503
      - 8810:8803
      - 9610:9633

      - 8819:8899
      - 7011:7001
      - 7012:7002
      - 7013:7003
    environment:
      - SHADOWCLJS_DEVTOOLS_URL_UI=http://localhost:9610
      - SHADOWCLJS_DEVTOOLS_PORT_UI=9503
      - SHADOWCLJS_NREPL_PORT_UI=8803

      - SHADOWCLJS_DEVTOOLS_URL_SCENARIO=http://localhost:9611
      - SHADOWCLJS_DEVTOOLS_PORT_SCENARIO=9611
      - SHADOWCLJS_NREPL_PORT_SCENARIO=8811

      - RSOCKET_PORT_UI=7001
      - RSOCKET_PORT_SCENARIO=7002
      - RSOCKET_PORT_PLAYER=7003
    networks:
      - base-network
    # user: 1000:1000
    volumes:
      - ./app-node/.peer1:/root
      # - type: volume
      #   source: deathstar-dir
      #   target: /root/.deathstar
      #   volume:
      #     nocopy: true
      # - ./app/.peer${PORTS_PREFIX}:/root/.deathstar
      - type: volume
        source: ctx
        target: /ctx
        volume:
          nocopy: true
    stdin_open: true
    tty: true
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 8192M

  peer2:
    image: deathstar.peer2
    build:
      context: ./peer
      dockerfile: ./Dockerfile
      args:
        workdir:  /ctx/DeathStarGame/bin/app-node
    command: tail -f /dev/null
    # command: bash f dev
    ports:
      - 8802:8899
      - 7020:7000
      - 7021:7001
      - 7022:7002
      # - 8085:8080
    networks:
      - base-network
    # user: 1000:1000
    volumes:
      - ./app-node/.peer2:/root
      # - type: volume
      #   source: deathstar-dir
      #   target: /root/.deathstar
      #   volume:
      #     nocopy: true
      # - ./app/.peer${PORTS_PREFIX}:/root/.deathstar
      - type: volume
        source: ctx
        target: /ctx
        volume:
          nocopy: true
    stdin_open: true
    tty: true
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 8192M

  peer3:
    image: deathstar.peer3
    build:
      context: ./peer
      dockerfile: ./Dockerfile
      args:
        workdir:  /ctx/DeathStarGame/bin/app-node
    command: tail -f /dev/null
    # command: bash f dev
    ports:
      - 8803:8899
      - 7030:7000
      - 7031:7001
      - 7032:7002
      # - 8085:8080
    networks:
      - base-network
    # user: 1000:1000
    volumes:
      - ./app-node/.peer3:/root
      # - type: volume
      #   source: deathstar-dir
      #   target: /root/.deathstar
      #   volume:
      #     nocopy: true
      # - ./app/.peer${PORTS_PREFIX}:/root/.deathstar
      - type: volume
        source: ctx
        target: /ctx
        volume:
          nocopy: true
    stdin_open: true
    tty: true
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 8192M