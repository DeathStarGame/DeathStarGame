#!/bin/bash

dev(){

  # lein repl :start :host 0.0.0.0 :port 7788
  # lein repl :headless :host 0.0.0.0 :port 7788
  # lein repl :connect 0.0.0.0:7878
  lein repl :headless

}

run_dev(){
  lein run dev
}

run_uberjar(){
  java -jar target/app.standalone.jar
}

uberjar(){
  lein with-profiles +prod uberjar
  # java -jar target/app.uber.jar 
}

native(){
  lein native-image
}

dock() {

    SUFFIX=$1
    IMAGE=deathstar
    NAME=deathstar-$SUFFIX
    REPL_PORT=77$SUFFIX$SUFFIX
    NETWORK=deathstar
    HOMEDIR_VOLUME=.user$SUFFIX
    SOURCE_DIR=/ctx
    WORKDIR=$SOURCE_DIR/DeathStarGame/bin
  
    docker build \
      -t $IMAGE \
      --build-arg workdir=$WORKDIR \
      -f Dockerfile .
    
    docker network create $NETWORK

    xhost +

    docker run  --rm \
                --cpus=4.0 \
                --gpus all \
                --memory=8g \
                --name $NAME \
                --privileged \
                --net=host \
                --device /dev/dri \
                -it \
                -p $REPL_PORT:7788 \
                -e DISPLAY=$DISPLAY \
                -v /tmp/.X11-unix:/tmp/.X11-unix \
                -v "$(pwd)/$HOMEDIR_VOLUME":/root \
                -v "$(cd ../../ && pwd)/":$SOURCE_DIR \
                 $IMAGE \
                 bash
}

"$@"